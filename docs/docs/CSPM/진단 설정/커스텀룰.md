---
layout: default
title: 커스텀 룰
parent: 진단 설정
grand_parent: "[CSPM]"
nav_order: 6
---

# 커스텀 룰
{: .no_toc }

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---

## 커스텀 룰
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_첫화면.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 화면</figcaption>
</center>
<br>

기본메뉴에서 **커스텀 룰** 메뉴를 클릭했을 때 나타나는 화면입니다. **커스텀 룰**은 사내 규정이나 자체 점검 기준에 맞춰 **기존 룰셋을 참조하거나 새로운 룰셋을 생성**하여 점검을 수행하는 기능입니다. 기본 제공 룰셋을 그대로 사용하지 않고, 조직의 정책에 맞게 **맞춤형 진단 구성을 직접 설정**할 수 있습니다.



---

## 커스텀 룰 추가
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_생성_1.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 1 (생성)</figcaption>
</center>

왼쪽 상단의 <img src="../../../../assets/images/button/생성버튼.png" alt="description" style="vertical-align:middle width:15px; height:15px;"> 버튼을 클릭하면 새로운 커스텀 룰을 생성할 수 있습니다.

### ① 기본정보

<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_항목명.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 2 (항목명, 항목 분류 선택)</figcaption>
</center>

<img src="../../../../assets/images/button/생성버튼.png" alt="description" style="vertical-align:middle width:15px; height:15px;"> 버튼을 클릭하여 **커스텀 룰 생성을 시작**합니다.  
먼저 **기본정보**를 입력합니다.  

가장 먼저 **커스텀 룰의 항목명**을 입력한 뒤,  
**항목 분류**에서 **기술 항목** 또는 **관리 항목** 중 하나를 선택합니다.

- **기술 항목**  
  시스템의 설정값이나 환경 구성을 **N1QL 쿼리**를 통해 실제로 점검하는 항목입니다.  
  예를 들어 보안 설정, 접근 제어 정책, 네트워크 구성 등과 같이 **실제 설정 상태를 조회·검증**하는 데 사용됩니다.  
  (※ 기술 항목은 쿼리 결과에 따라 자동으로 “양호/취약/N/A” 판정이 결정됩니다.)

- **관리 항목**  
  별도의 설정 조회나 쿼리 동작 없이 **항목 자체만 정의하는 관리용 점검 항목**입니다.  
  사용자가 직접 “양호 / 취약 / N/A” 상태를 선택하여 관리 점검 결과를 기록할 수 있으며,  
  실제 설정값을 확인하거나 자동 진단 기능을 수행하지는 않습니다.  
  다만, **보고서에는 일반 항목과 동일하게 포함**되어 관리 항목의 점검 결과를 함께 확인할 수 있습니다


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_프로바이더.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 3 (프로바이더 선택)</figcaption>
</center>

커스텀 룰 생성 화면에서 **항목 분류**를 **기술 항목**으로 선택한 경우, 해당 룰이 참조할 **프로바이더(Provider)**를 선택하여 진행합니다.  

프로바이더는 진단 대상 환경의 **설정 데이터를 수집·조회하는 소스**로, 선택한 프로바이더에 따라 사용 가능한 **N1QL 쿼리 템플릿** 또는 **리소스 항목**이 달라집니다.


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_리소스분류.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 4 (리소스 분류, 코드접두소, 항목코드 입력)</figcaption>
</center>

① **리소스 분류**에는 예를 들어 `IAM`과 같은 진단 대상 리소스를 입력합니다.  

② **코드 접두사**를 입력합니다.  
코드 접두사는 기존 항목 코드와 중복되지 않도록 구분하기 위한 **필수 값**입니다.  

③ **항목 코드**를 입력합니다.  
항목 코드는 커스텀 룰을 식별하고 관리하기 위한 고유한 코드로, 각 항목을 명확히 구분할 수 있도록 설정합니다.


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_위험도.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 5 (위험도 선택, 항목 설명, 진단 기준, 조치 방안 입력)</figcaption>
</center>

① **위험도(Risk Level)** 는 해당 항목의 위험 수준을 선택하는 항목입니다.  
<span style="color:red;">High</span> · <span style="color:orange;">Medium</span> · <span style="color:gold;">Low</span> 중 하나를 선택합니다.

② **항목 설명**: 항목의 목적과 점검 대상을 입력합니다.  
③ **진단 기준**: 양호/취약 판정 기준을 작성합니다.  
④ **조치 방안**: 취약 발생 시의 대응 또는 개선 방법을 작성합니다.  

모든 입력 항목은 **Markdown 언어**를 지원합니다.

---

### ② 쿼리 작성

<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_쿼리작성.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 6 (쿼리 작성)</figcaption>
</center>

기본정보 입력을 완료하면 <img src="../../../../assets/images/button/커스텀룰_생성_next.png" alt="description" style="vertical-align:middle width:17px; height:17px;"> 버튼을 클릭하여 **쿼리 작성**으로 단계로 넘어갑니다.

<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_조회대상.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 7 (조회 대상 선택)</figcaption>
</center>

**조회 대상**은 쿼리 결과에 따라 항목의 판정을 어떻게 처리할지 선택하는 옵션입니다.  
예: **취약**을 선택한 경우, 쿼리 실행 결과로 대상이 출력되면 해당 항목을 **취약**으로 판정합니다.


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_양호쿼리수행.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 8 (양호 쿼리 수행 선택)</figcaption>
</center>

**양호 쿼리 수행**은 쿼리 결과에 포함되지 않은 대상을 조회하는 기능입니다.  
이 기능을 **‘수행’**으로 설정하면, 지정한 **서비스**와 **리소스**를 기준으로 **쿼리 결과에 해당하지 않는 모든 대상**을 결과로 표시합니다.
또한 선택할 수 있는 서비스와 리소스에 대해서만 정보를 게더링 하기에 이외의 서비스와 리소스에서는 점검할 수 없습니다.

> **예시**  
> 예를 들어, 쿼리가 “비밀번호 정책이 미적용된 관리자 계정”을 반환한다고 가정하면,  
> ‘양호 쿼리 수행’을 **수행**으로 설정할 경우 해당 쿼리 결과에 **포함되지 않는**(즉, 비밀번호 정책이 적용된) 관리자 계정들이 출력됩니다.  
> (요약: 쿼리 결과가 ‘문제 있는 항목’이라면, 양호 쿼리는 그 반대 집합—문제가 없는 항목—을 보여줍니다.)

또한, **선택한 서비스와 리소스에 대해서만 데이터가 수집(Gathering)** 되므로,  
이외의 서비스나 리소스는 점검할 수 없습니다.  
즉, 지정된 범위를 벗어난 리소스는 쿼리 수행 및 결과 표시 대상에 포함되지 않습니다.


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_쿼리정보확인.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 9 (Query Editor - 쿼리 정보 확인)</figcaption>
</center>

**Query Editor**에 찾고자 하는 정보를 입력하여 쿼리를 작성합니다.  
쿼리 언어로는 **N1QL**이 사용됩니다.  
화면에 표시된 **Query Editor 옆의 <img src="../../../../assets/images/button/info아이콘.png" alt="description" style="vertical-align:middle width:17px; height:17px;"> ‘쿼리 정보’ 아이콘**을 클릭하면 기본 문법을 확인할 수 있습니다.  
또한 [N1QL SELECT 문법 공식 문서](https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/select-syntax.html)를 통해 상세한 문법을 참고할 수 있습니다.


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_Launch.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 10 (Launch - Pod실행)</figcaption>
</center>

쿼리를 직접 **실행하여 결과를 확인**할 수 있습니다.  
<img src="../../../../assets/images/button/Launch버튼.png" alt="launch button" style="vertical-align:middle; width:45px; height:20px;"> **[Launch]** 버튼을 클릭하면 **Custom Rule Query를 수행할 Account Key 목록**이 표시됩니다.  

목록에서 쿼리를 실행할 **Account Key**를 선택하면, 해당 키 정보를 기반으로 한 **Pod(실행 환경)** 이 생성됩니다.  
이때 표시되는 데이터는 이전에 **거버넌스 진단** 과정에서 수집(Gathering)된 정보를 활용한 것입니다.  

**새로고침** 버튼을 눌러 **키 옆에 초록색 표시**가 나타나면, Pod가 정상적으로 실행된 상태를 의미합니다.


<br>
<center>
    <img
        src="../../../../assets/images/커스텀룰/커스텀룰_생성_Execute.png"
        width="1600"
        height="900"
        style="border: 2px solid black;"
    />
    <figcaption>커스텀 룰 생성 – 11 (Execute - 쿼리 실행)</figcaption>
</center>

실행된 Pod가 있는 쿼리를 수행할 **Account Key**를 체크한 뒤, <img src="../../../../assets/images/button/Execute버튼.png" alt="Execute button" style="vertical-align:middle; width:45px; height:20px;"> **[Execute]** 버튼을 클릭하면 **Results** 영역에 쿼리 결과가 표시됩니다.  

- **Response 1** : 쿼리의 실행 결과값을 보여줍니다.  
- **Response 2** : 쿼리 결과의 **반대집합 리소스**를 표시합니다.
  이 영역은 **양호 쿼리 수행** 옵션을 선택했을 때만 나타납니다.

쿼리 작성을 완료한 후  
<img src="../../../../assets/images/button/저장버튼.png" alt="Save button" style="vertical-align:middle; width:40px; height:20px;"> 버튼을 클릭하여 커스텀 룰을 저장합니다.  

저장한 커스텀 룰을 사용하여 진단하기 위해서는 **해당 커스텀 룰을 거버넌스에 추가**해야 합니다.  
이 과정을 통해 새로 작성한 룰이 실제 진단 항목으로 포함되어 점검이 수행됩니다.

---

### ※ 쿼리 작성 예시  
**EBS 스냅샷 퍼블릭 차단 (Block Public Access for Snapshots)** 확인 쿼리 작성 할 때

| 구분 | 내용 |
|:----|:----|
| <center><img src="../../../../assets/images/커스텀룰/커스텀룰_쿼리작성_api확인.png" width="700" height="300" style="border: 1px solid black;"/></center> | 확인하고자 하는 API 값을 조회하는 화면입니다.<br>기본적으로 **boto3 API** 규격을 따릅니다. |
| <center><img src="../../../../assets/images/커스텀룰/커스텀룰_쿼리작성_데이터구조확인.png" width="700" height="300" style="border: 1px solid black;"/></center> | 데이터 구조와 내가 찾는 값의 데이터 구조를 찾기위해 서비스와 리소스를 선택 후 Execute를 합니다. 단 표시되는 데이터는 이전에 **거버넌스 진단** 과정에서 수집(Gathering)된 정보를 활용한 것이므로 먼저 최소 1번의 거버넌스 진단이 필요합니다. |
| <center><img src="../../../../assets/images/커스텀룰/커스텀룰_쿼리작성_데이터위치확인.png" width="700" height="300" style="border: 1px solid black;"/></center> | 찾은 데이터에서 내가 찾는 값의 위치를 확인합니다. |
| <center><img src="../../../../assets/images/커스텀룰/커스텀룰_쿼리작성_쿼리작성.png" width="700" height="300" style="border: 1px solid black;"/></center> | 내가 찾는 값과 값의 위치 확인 후 쿼리를 작성합니다. 여기서는 스냅샷의 퍼블릭 차단이 안되어있는것을찾기에 State 값이 unblocked인 것을 찾기위한 쿼리를 작성하였습니다. |




